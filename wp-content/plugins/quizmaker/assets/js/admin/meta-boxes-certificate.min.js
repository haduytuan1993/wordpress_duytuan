jQuery(function(t){var e=function(){return{init:function(){this.setupEvironment(),this.setupData(meta_boxes_certificate.data),this.events()},events:function(){this.subPanelEvent(),this.previewEvent(),this.addBackgroundEvent(),this.addNameEvent(),this.addDateEvent(),this.addRankEvent(),this.addScoreEvent(),this.addCustomTextEvent(),this.addTestNameEvent(),this.addCertIDEvent(),this.addRandomCertIDEvent(),this.addUserMetaEvent()},setupEvironment:function(){this.data=[],this.metaBox=t("#quizmaker-certificate-data"),this.container=t("#qm_certificate_compose_scrollpanel"),this.subPanel=this.metaBox.find(".qm_certificate_compose_action_sub-panel"),this.panel=this.container.find(".jspPane"),this.container.jScrollPane()},setupData:function(e){if(e.length>0){var a=this;t.each(e,function(t,e){switch(e.type){case"name":a.addName(e);break;case"date":a.addDate(e);break;case"rank":a.addRank(e);break;case"text":a.addCustomText(e);break;case"test_name":a.addTestName(e);break;case"usermeta":a.addUserMeta(e);break;case"id":a.addID(e);break;case"random_cert_id":a.addRandomCertID(e)}})}},reset:function(){this.metaBox.find(".element_certificate").remove()},refresh:function(){var t=this.container.data("jsp");void 0!==t&&t.reinitialise()},saveData:function(){QM_Model().save({action:"quizmaker_save_certificate",id:meta_boxes_certificate.post_id,data:this.data}).then(function(t){QM().Message().inform("Save Success")})},addData:function(t){return this.data.push(t),this.data.length},removeData:function(t){this.data.splice(t,1);var e=this.data;this.data=[],this.reset(),this.setupData(e)},removeAll:function(){this.data=[],this.reset()},updateData:function(e,a){a=t.extend(this.data[e],a),this.data[e]=a},getElement:function(e){void 0===e&&(e=this.selectedIndex);var a=t("#qm_certificate_compose_scrollpanel .jspPane").children(".element_certificate").filter(function(){return t(this).data("index")==e});return a.length>0&&a},subPanelEvent:function(){var e=this;this.subPanel.find("input, select").change(function(){e.data[e.selectedIndex][t(this).data("name")]=t(this).val();var a=e.getElement();a&&(e.updateElement(a,e.data[e.selectedIndex]),t(".element_certificate").draggable("option","refreshPositions",!0))}),this.subPanel.find("#qm_certificate_color").wpColorPicker({defaultColor:"#000000",change:function(a,n,i){e.data[e.selectedIndex][t(this).data("name")]=n.color.toString();var d=e.getElement();d&&e.updateElement(d,e.data[e.selectedIndex])}}),this.metaBox.find(".qm_certificate_save").click(function(t){t.preventDefault(),e.saveData()}),this.metaBox.find(".qm_certificate_remove").click(function(t){t.preventDefault(),e.removeData(e.selectedIndex)})},previewEvent:function(){var e=this;t(".post-type-certificate #post-preview").unbind("click").click(function(t){return t.preventDefault(),e.preview(),!1})},preview:function(){var e=QM().Loading();e.show(),QM_Model().get({action:"quizmaker_preview_certificate",id:meta_boxes_certificate.post_id}).then(function(a){t('<img src="'+a.url+'" alt="Preview Certficate"/>').imagesLoaded().done(function(n){var i=n.images[0].img.width,d=n.images[0].img.height;e.hide(),QM_Dialog(t('<div style="width:100%; height:100%; overflow:scroll;"><img src="'+a.url+'" alt="Preview Certficate" style="width:100%; height:auto"/></div>'),{title:"Certificate Preview",width:i,height:d}).show()})})},updateTextPanel:function(t){this.subPanel.css("display","none");var e=this.subPanel.filter(".text"),a=e.find("#qm_certificate_font_size"),n=e.find("#qm_certificate_font_family"),i=e.find("#qm_certificate_text"),d=e.find("#qm_certificate_text_align"),s=e.find("#qm_certificate_color");e.css("display","block"),a.val(this.data[t].font_size),n.val(this.data[t].font_name),d.val(this.data[t].text_align),s.val(this.data[t].color),void 0!==this.data[t].content?i.val(this.data[t].content):i.val("")},addElement:function(e,a){var n=this;return a=t.extend({x:10,y:10},a),QM_Model().post({action:"quizmaker_get_text_boudingbox_certificate",data:a}).then(function(t){t&&(a.width=t.width,a.height=t.height,a.image_base64=t.image_base64,n._addElement(e,a))}),e},_addElement:function(e,a){var n=this;e=this.applyStyle(e,a),e=this.attachDragEvent(e);var i=parseInt(this.addData(a))-1;return e.data("index",i),e.data("type",a.type),e.click(function(e){e.preventDefault(),n.selectedIndex=t(this).data("index"),n.updateTextPanel(n.selectedIndex),t(".element_certificate").removeClass("active"),t(this).addClass("active")}),this.selectedIndex=i,this.updateTextPanel(this.selectedIndex),this.container.find(".jspPane").append(e),e},updateElement:function(t,e){var a=this;QM_Model().post({action:"quizmaker_get_text_boudingbox_certificate",data:e}).then(function(n){n&&(e.width=n.width,e.height=n.height,e.image_base64=n.image_base64,a.applyStyle(t,e))})},applyStyle:function(e,a){a=t.extend({x:10,y:10,color:"#000",font_name:"Arial",font_size:"30px"},a),e.css({position:"absolute",top:parseInt(a.y),left:parseInt(a.x),height:parseInt(a.height),"font-size":a.font_size+"px",color:a.color}),e.html('<img src="data:image/png;base64,'+a.image_base64+'"/>');var n=e.find("img");switch(a.text_align){case"center":n.css({left:-parseInt(a.width)/2+"px"});break;case"right":n.css({left:-parseInt(a.width)+"px"});break;default:n.css({left:0})}return e},attachDragEvent:function(t){var e=this;return t.draggable({containment:this.container.find(".jspContainer"),cursor:"move",stop:function(a,n){var i=t.data("index"),d={x:n.position.left,y:n.position.top};e.updateData(i,d)}}),t},addBackgroundEvent:function(){var e,a=this,n=t("#quizmaker-certificate-data"),i=n.find(".qm_media_upload");n.find(".delete-custom-img"),n.find(".qm_certificate_compose_container"),n.find("#qm_certificate_data_background");i.click(function(t){if(t.preventDefault(),e)return void e.open();e=wp.media({title:"Select or Upload Media Of Your Chosen Persuasion",button:{text:"Use this media"},multiple:!1}),e.on("select",function(){var t=e.state().get("selection").first().toJSON();a.removeAll(),a.addBackground(t),setTimeout(function(){a.refresh()},500)}),e.open()})},addBackground:function(e){var a=t("#quizmaker-certificate-data"),n=a.find(".qm_certificate_compose_container .background"),i=a.find("#qm_certificate_background"),d=t("<img/>");d.attr("src",e.url),n.html(d),i.val(e.id)},addCustomTextEvent:function(){var t=this;this.metaBox.find(".qm_add_text-custom").click(function(e){e.preventDefault(),t.addCustomText()})},addCustomText:function(e){e=t.extend({type:"text",font_size:30,font_name:"opensans_regular",content:"Custom Text",color:"#000000",text_align:"left"},e),this.addElement(t('<div class="element_certificate element_certificate-text"></div>'),e)},addNameEvent:function(){var t=this;this.metaBox.find(".qm_add_text-name").click(function(e){e.preventDefault(),t.addName()})},addName:function(e){e=t.extend({type:"name",content:"[name]",font_size:30,font_name:"opensans_regular",color:"#000000",text_align:"left"},e),this.addElement(t('<div class="element_certificate element_certificate-name align-'+e.text_align+'"/>'),e)},addDateEvent:function(){var t=this;this.metaBox.find(".qm_add_text-date").click(function(e){e.preventDefault(),t.addDate()})},addDate:function(e){e=t.extend({type:"date",content:"[date]",font_size:30,font_name:"opensans_regular",color:"#000000",text_align:"left"},e);var a=t('<div class="element_certificate element_certificate-date align-'+e.text_align+'"><span class="el center"></span></div>');a=this.addElement(a,e)},addRankEvent:function(){var t=this;this.metaBox.find(".qm_add_text-rank").click(function(e){e.preventDefault(),t.addRank()})},addRank:function(e){e=t.extend({type:"rank",content:"[rank]",font_size:30,font_name:"opensans_regular",color:"#000000",text_align:"left"},e),this.addElement(t('<div class="element_certificate element_certificate-rank align-'+e.text_align+'">[rank]</div>'),e)},addTestName:function(e){e=t.extend({type:"test_name",content:"[Test Name]",font_size:30,font_name:"opensans_regular",color:"#000000",text_align:"left"},e),this.addElement(t('<div class="element_certificate element_certificate-test-name">[Test Name]</div>'),e)},addScore:function(e){e=t.extend({type:"score",content:"[score]",font_size:30,font_name:"opensans_regular",color:"#000000",text_align:"left"},e),this.addElement(t('<div class="element_certificate element_certificate-score align-'+e.text_align+'">[score]</div>'),e)},addUserMeta:function(e){e=t.extend({type:"usermeta",content:"",name:"",font_size:30,font_name:"opensans_regular",color:"#000000",text_align:"left"},e),this.addElement(t('<div class="element_certificate element_certificate-usermeta">['+e.content+"]</div>"),e)},addID:function(e){e=t.extend({type:"id",content:"[Certificate ID]",font_size:30,font_name:"opensans_regular",color:"#000000",text_align:"left"},e),this.addElement(t('<div class="element_certificate element_certificate-id">[ID]</div>'),e)},addRandomCertID:function(e){e=t.extend({type:"random_cert_id",content:"[User Cert ID]",font_size:30,font_name:"opensans_regular",color:"#000000",text_align:"left"},e),this.addElement(t('<div class="element_certificate element_certificate-random-cert-id">[User Cert ID]</div>'),e)},addScoreEvent:function(){var t=this;this.metaBox.find(".qm_add_text-score").click(function(e){e.preventDefault(),t.addScore()})},addTestNameEvent:function(){var t=this;this.metaBox.find(".qm_add_text-test-name").click(function(e){e.preventDefault(),t.addTestName()})},addCertIDEvent:function(){var t=this;this.metaBox.find(".qm_add_text-id").click(function(e){e.preventDefault(),t.addID()})},addRandomCertIDEvent:function(){var t=this;this.metaBox.find(".qm_add_text-random-cert-id").click(function(e){e.preventDefault(),t.addRandomCertID()})},addUserMetaEvent:function(){var e=this;this.metaBox.find(".qm_add_text-usermeta").click(function(a){a.preventDefault(),e.addUserMeta({content:"["+t(this).data("label")+"]",name:t(this).data("name")})})}}},a=function(){return{init:function(){this.table_data=new AWS_Table_Data(t(".qm-list-certificate-tests"),{delay:1}),this.events(),this.table_data.init()},events:function(){var e=this;t("#add-test-to-certificate").click(function(a){var n=t("#input-search-tests").val();n&&t.when(e.table_data.action("add",{data:{ids:n}})).then(function(){e.table_data.refresh(),t("#input-search-tests").val("").trigger("change")}),a.preventDefault()}),t("#remove-test-from-certificate").click(function(a){var n=e.table_data.get_selected(),i=t(this);i.addClass("disabled"),n.length>0&&t.when(e.table_data.action("remove",{data:{ids:n}})).then(function(){e.table_data.refresh(),i.removeClass("disabled")}),a.preventDefault()}),t(".qm-list-certificate-tests").on("aws-table-data-after-loading-data",function(){t(this).find(".pass").change(function(){var a=parseInt(t(this).val()),n=parseInt(t(this).data("id"));t.when(e.table_data.action("add_pass",{data:{id:n,pass:a}})).then(function(){})})})}}};t(document).ready(function(){e().init(),a().init()})});