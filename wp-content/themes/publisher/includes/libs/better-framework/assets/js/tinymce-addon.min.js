var BetterStudio_TinyMCE_View={settings:{},fetchShortcodes:[],shortcodeCounter:0,fetchAllQueue:0,repeaterPrefix:"bf-metabox-option",init:function(t){var e=this;BF_TinyMCE_View.shortcodes&&BF_TinyMCE_View.shortcodes.forEach(function(t){e.registerView(t)}),this.$=t},initEditModal:function(t){var o=this,n=o.$(".tinymce-addon-fields",t);function s(){n.children(".group").hide()}n.length&&(s(),n.children(".group:first").show(),o.$(".tabs-wrapper li:first").addClass("active-tab"),o.$(".bf-tab-item-a",n).on("click",function(){var t=o.$(this).closest("li"),e="bf-tmv-"+t.data("go");t.addClass("active-tab"),t.siblings("li").removeClass("active-tab");e=o.$("#"+e,n);s(),e.fadeIn(500),e.find(":input:first").trigger("force-change")}))},setSettings:function(t){t&&t.shortcode&&(this.settings[t.shortcode]=t.settings)},getSettings:function(t){return this.settings[t]},registerView:function(t){(t=_.extend({},{extend:{}},t)).settings&&this.setSettings(t),wp.mce.views.register(t.shortcode,_.extend({},this.viewsBaseClass(t),t.extend))},doShortcode:function(t,e){var o=this;clearTimeout(o.fetchAllQueue),o.fetchAllQueue=setTimeout(function(){o.fetchAllShortcodes.call(o)}),o.fetchShortcodes.push({query:{shortcode:t,id:o.shortcodeCounter},id:o.shortcodeCounter,view:e}),o.shortcodeCounter++},fetchAllShortcodes:function(){var t,e,o=this,n=_.pluck(o.fetchShortcodes,"query"),s=parseInt(BF_TinyMCE_View.doshortcode_steps||5),i=_.groupBy(n,function(t,e){return Math.floor(e/s)}),r=Better_Framework._length(i),c=0;for(e in i)t=i[e],wp.ajax.post("bf_ajax",{reqID:"fetch-mce-view-shortcode",nonce:better_framework_loc.nonce,shortcodes:t,post_id:wp.media.view.settings.post.id}).done(function(t){_.each(t,function(t,e){e=_.findWhere(o.fetchShortcodes,{id:parseInt(e)});e&&e.view&&("no-items"===t.type?e.view.setError("["+e.view.shortcode.tag+"]<br/>"+t.message,"no-alt"):e.view.render(t))})}).always(function(){++c===r&&(o.fetchShortcodes=[],o.shortcodeCounter=0)})},viewsBaseClass:function(t){var l=this;if(wp.mce.bsShortcodes)return wp.mce.bsShortcodes;return wp.mce.bsShortcodes={args:{},initialize:function(){l.doShortcode(this.shortcode.string(),this)},shortcode_data:{},edit:function(t,d){var a=this,t=wp.shortcode.next(a.shortcode.tag,t),h=t.shortcode.attrs.named;h.innercontent=t.shortcode.content;var s={custom_event:{label:BS_Shortcode_loc.save,type:"primary",clicked:function(){var e=this,c={};l.$(".bs-modal-body",this.$modal).clone();l.$(".mce-field",this.$modal).each(function(){if("radio"!==this.type||this.checked){var t=this.name.match(/\[(.*?)\]/g);if(t){var e=this.name.match(/^(.*?)(?=\[)/)[1];void 0===c[e]&&(c[e]={});for(var o=c[e],n=0;n<t.length;n++)void 0===o[e=t[n].substr(0,t[n].length-1).substr(1)]&&(o[e]={}),o=o[e];o&&(o.__VALUE__=this.value)}else c[this.name]=this.value}}).promise().done(function(){var o,n,s,i=l.getSettings(a.shortcode.tag),r="";if(i.sub_shortcodes)for(o in i.sub_shortcodes)c[o]&&(n=i.sub_shortcodes[o],_.each(c[o],function(t){t=_.mapObject(t,function(t){return"object"==typeof t&&"__VALUE__"in t?t.__VALUE__:t});var e="";(s="string"==typeof i.extra.shortcode_content_fields[o]?i.extra.shortcode_content_fields[o]:"")&&void 0!==t[s]&&(e=t[s],delete t[s]),r+="\n\t",r+=wp.shortcode.string({tag:n,content:e,attrs:t,type:"close"})}),delete c[o]);r&&(r+="\n");var t=function(t){var e,o={};for(e in t)if("object"==typeof t[e])for(var n in o[e]="",t[e])t[e][n]&&void 0!==t[e][n].__VALUE__&&""!=t[e][n].__VALUE__&&"0"!=t[e][n].__VALUE__&&(o[e]+=n+",");else o[e]=t[e];return o}(c);h.id&&void 0===t.id&&(t.id=h.id),void 0===t._content||r||(r=t._content,delete t._content),d(wp.shortcode.string({tag:a.shortcode.tag,attrs:t,type:"open",content:r}),!1),e.close_modal("tinymce")})}},close_modal:{type:"secondary",action:"close",label:better_framework_loc.translation.reset_panel.button_no,focus:!0}},i=l.$.bs_modal({modalId:"es-modal",skin:"loading",content:{header:"Loading...",title:"Loading...",body:""},buttons:s,events:{before_append_html:function(){this.$overlay.css("z-index",155e3),this.$modal.css("z-index",155001)},after_append_html:function(){l.initEditModal(this.$modal)}}});wp.ajax.post("bf_ajax",{action:"bf_ajax",reqID:"fetch-mce-view-fields",nonce:better_framework_loc.nonce,shortcode:a.shortcode.tag,shortcode_content:t.shortcode.content,shortcode_values:h}).done(function(t){var e,o,n;i.change_skin({skin:"skin-1",animations:{},content:{header:(e=BF_TinyMCE_View.l10n.modal.header,o=l.getSettings(a.shortcode.tag),n=o.name||"",t.settings&&(o.extra=t.settings,l.setSettings({settings:o,shortcode:a.shortcode.tag})),e.toString().replace("%shortcode%",n)),title:"",body:t.output},buttons:s}),jQuery(document).trigger("mce-view-fields-loaded",[i])})}},wp.mce.bsShortcodes}};jQuery(function(){BetterStudio_TinyMCE_View.init(jQuery)});